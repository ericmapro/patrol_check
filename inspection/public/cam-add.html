<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./css/font.css">
  <link rel="stylesheet" href="./css/xadmin.css">
  <script src="formjs/dictionaries.js" type="text/javascript"></script>
  <script type="text/javascript" src="js/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
  <script type="text/javascript" src="./js/xadmin.js"></script>
  <script src="js/jquery.cookie.js" type="text/javascript"></script>
</head>
<body>
  <div class="x-body">
    <form class="layui-form">
      <div class="layui-form-item">
        <label for="name" class="layui-form-label">
          <span class="x-red">*</span><span id="sp1"></span>
        </label>
        <div class="layui-input-inline">
          <input type="text" id="name"  lay-verify="nikename" autocomplete="off"maxlength="20"
          onkeyup="value=value.replace(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5]/g,'')" 
          onpaste="value=value.replace(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5]/g,'')" 
          oncontextmenu = "value=value.replace(/[^\a-\z\A-\Z0-9\u4E00-\u9FA5]/g,'')"
            class="layui-input">
        </div>

        <label id="lab1" class="layui-form-label">
        </label>
        <div class="layui-input-inline">
          <select id="selsequence" class="valid">
					</select>
        </div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">
          <span id="sp10"></span>
        </label>
        <div class="layui-input-inline">
          <select id="selcj" class="valid" lay-filter="selcj">
					</select>
        </div>
        <label class="layui-form-label">
          <span id="sp100"></span>
        </label>
        <div class="layui-input-inline">
          <select id="selyg" class="valid" lay-filter="selyg">
					</select>
        </div>
        <div id="imsg3" class="layui-form-mid layui-word-aux">
				</div>
      </div>
      <div class="layui-form-item dvadd">
        <label class="layui-form-label">
          <span id="sp14"></span>
        </label>
        <div class="layui-input-inline">
          <select id="selml" class="valid">
					</select>
        </div>
        <div id="imsg1" class="layui-form-mid layui-word-aux">
				</div>
      </div>
      <div class="layui-form-item dvadd">
        <label class="layui-form-label">
          <span class="x-red">*</span><span id="sp11"></span>
        </label>
        <div class="layui-input-inline">
          <input type="text" id="passip"   lay-verify="ip" autocomplete="off"
          onkeyup="value=value.replace(/[^0-9\.]/g,'')" 
					onpaste="value=value.replace(/[^0-9\.]/g,'')" 
					oncontextmenu = "value=value.replace(/[^0-9\.]/g,'')"
            class="layui-input" maxlength="15">
        </div>
        <label class="layui-form-label">
          <span>人员检测时间</span>
        </label>
        <div class="layui-input-inline">
          <select id="selpc" class="valid">
					</select>
        </div>
        <div class="layui-form-mid layui-word-aux">(分钟) (设置巡检人员进入该检测区域内最短的检测时间)
				</div>
      </div>
      <div class="layui-form-item dvadd">
        <label class="layui-form-label">
          <span class="x-red">*</span><span id="sp15"></span>
        </label>
        <div class="layui-input-inline">
          <input type="text" id="camport"   lay-verify="port" autocomplete="off" value="554"
          onkeyup="value=value.replace(/[^0-9]/g,'')" 
					onpaste="value=value.replace(/[^0-9]/g,'')" 
					oncontextmenu = "value=value.replace(/[^0-9]/g,'')"
            class="layui-input" maxlength="4">
        </div>
      </div>
      <div class="layui-form-item dvadd">
        <label class="layui-form-label">
          <span class="x-red">*</span><span id="sp12"></span>
        </label>
        <div class="layui-input-inline">
          <input type="text" id="username"   lay-verify="uname" autocomplete="off"
          onkeyup="value=value.replace(/[^\a-\z\A-\Z0-9]/g,'')" 
          onpaste="value=value.replace(/[^\a-\z\A-\Z0-9]/g,'')" 
          oncontextmenu = "value=value.replace(/[^\a-\z\A-\Z0-9]/g,'')"
            class="layui-input" maxlength="20">
        </div>
      </div>
      <div class="layui-form-item dvadd">
        <label class="layui-form-label">
          <span class="x-red">*</span><span id="sp13"></span>
        </label>
        <div class="layui-input-inline">
          <input type="text" id="userpass"   lay-verify="upass" autocomplete="off"
            class="layui-input" maxlength="20">
        </div>
      </div>
      <div id="dvadd" class="layui-form-item" style="display: none;">
        <label class="layui-form-label">
          <span id="sp3"></span>
        </label>
        <div class="layui-input-inline" style="width:500px;">
          <input type="text" id="camaddress" autocomplete="off"
            class="layui-input" style="width:500px;">
        </div>
        <div id="imsg2" class="layui-form-mid layui-word-aux">
				</div>
      </div>
      <div class="layui-form-item">
        <label class="layui-form-label">检测类别</label>
        <div class="layui-input-block">
          <input type="checkbox" id="feedback" name="like[write]" value="1" title="工服工帽" checked="" >
          <input type="checkbox" id="feedback" name="like[read]" value="2" title="气体检测仪器" checked="" >
          <input type="checkbox" id="feedback" name="like[game]" value="3" title="静电服" checked="">
          <input type="checkbox" id="feedback" name="like[game]" value="4" title="触摸静电球">
          <input type="checkbox" id="feedback" name="like[write]" value="5" title="抽烟" checked="" >
          <input type="checkbox" id="feedback" name="like[read]" value="6" title="接打电话" checked="" >
          <input type="checkbox" id="feedback" name="like[game]" value="7" title="烟火" checked="">
        </div>
      </div>
      
      <div class="layui-form-item">
        <label for="L_repass" class="layui-form-label">
        </label>
        <button id="laysavebutton" class="layui-btn" lay-filter="add" lay-submit="">
        </button>
      </div>
      
    </form>
  </div>
  <script>
    function GetQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURI(r[2]); return null;
    }

    var vcamid = GetQueryString("camid");
    var layer;
    var form;

    layui.use(['form', 'layer'], function () {
      $ = layui.jquery;
      form = layui.form;
      layer = layui.layer;
      var vnowdate = new Date();

      form.verify({
        nikename: function (value) {
          if (value.length < 1) {
            return dictionaries_message67;
          }
        }, 
        ip: function (value) {
          if($("#selcj").val() != '5')
          {
            if (value.length < 1) {
              return dictionaries_message68;
            }
            else{
							var reg = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;
							if(!reg.test(value))
							{
								return dictionaries_message256;
							}
						}
          }
        }, 
        uname: function (value) {
          if($("#selcj").val() != '5')
          if (value.length < 1) {
            return dictionaries_message263;
          }
        }, 
        upass: function (value) {
          if($("#selcj").val() != '5')
          if (value.length < 1) {
            return dictionaries_message264;
          }
        }, 
        port: function (value) {
          if($("#selcj").val() != '5')
          if (value.length < 1) {
            return dictionaries_message184;
          }
        }
      });

      form.on('select(selcj)', function (data) {
				var typestr = data.value;
				$("#dvadd").hide();

				if (typestr == "5") {
					$("#dvadd").show();
          $(".dvadd").hide();
				}
        else{
          $("#dvadd").hide();
          $(".dvadd").show();
        }
			});

      form.on('submit(add)', function (data) {

        var arr_box = '';
        $('input[type=checkbox]:checked').each(function() {
          arr_box += ',' + $(this).val();
        });
        arr_box = arr_box.substring(1);
    
        var vname = $("#name").val();
        var vselcj = $("#selcj").val();
        var vselml = $("#selml").val();
        var vpassip = $("#passip").val();
        var vcamport = $("#camport").val();
        var vusername = $("#username").val();
        var vuserpass = $("#userpass").val();
        var vselsequence = $("#selsequence").val();
        var vselpc = $("#selpc").val();
        var vselyg = $("#selyg").val();
        var vcamrtsp = '';
        if(vselcj == '5')
        {
          vcamrtsp = $("#camaddress").val();
        }
        else{
          vcamrtsp = getrtsp(vpassip,vcamport,vusername,vuserpass,vselcj,vselml);
        }
        var now = new Date();
        if (vcamid != null) {
          $.get("http://" + $.cookie('ip') + ":" + $.cookie('port') + "/cams/update", {
            "camid": vcamid, "camname": vname,"camerafactory": vselcj,"codestream": vselml,
            "ipaddress": vpassip,"rtspport": vcamport,"username": vusername,"password": vuserpass,"url": vcamrtsp,
            "sequence": vselsequence,"category":arr_box,"detectlevel":vselyg,"staytime":vselpc, "Rtn": now.getTime()
          }, function (data) {
            if (data == 'ok') {
              layer.alert(dictionaries_message65, { icon: 6 ,title:dictionaries_message241,btn:[dictionaries_message63]}, function () {
                var index = window.name.substring(18);
                window.parent.postMessage(index, '*');
                layer.closeAll();
                closewindow();
              });
            }
            else {
              layer.alert(dictionaries_message66, { icon: 2 ,title:dictionaries_message241,btn:[dictionaries_message63]}, function () {
                var index = window.name.substring(18);
                window.parent.postMessage(index, '*');
                layer.closeAll();
              });
            }
          });
        }
        else {
          $.get("http://" + $.cookie('ip') + ":" + $.cookie('port') + "/cams/save", {
            "camname": vname,"camerafactory": vselcj,"codestream": vselml,
            "ipaddress": vpassip,"rtspport": vcamport,"username": vusername,"password": vuserpass,"url": vcamrtsp,
            "sequence": vselsequence,"category":arr_box,"detectlevel":vselyg,"staytime":vselpc, "Rtn": now.getTime()
          }, function (data) {
            if (data == 'ok') {
              layer.alert(dictionaries_message65, { icon: 6 ,title:dictionaries_message241,btn:[dictionaries_message63]}, function () {
                var index = window.name.substring(18);
                window.parent.postMessage(index, '*');
                layer.closeAll();
               
              });
            }
            else {
              layer.alert(dictionaries_message66, { icon: 2 ,title:dictionaries_message241,btn:[dictionaries_message63]}, function () {
                var index = window.name.substring(18);
                window.parent.postMessage(index, '*');
                layer.closeAll();
              });
            }
          });
        }
        return false;
      });
      chgLang();
      getinfo_cam();
    });

    function getinfo_cam() {
      if (vcamid != null) {
        var now = new Date();
        $.get("http://" + $.cookie('ip') + ":" + $.cookie('port') + "/cams/searchbyid", { "camid": vcamid, "Rtn": now.getTime() }, function (data) {
          $("#name").val(data[0].camera_name);
          $("#camaddress").val(data[0].url);
          $("#selcj").val(data[0].camera_factory);
          $("#selml").val(data[0].code_stream);
          $("#passip").val(data[0].ip_address);
          $("#camport").val(data[0].rtsp_port);
          $("#username").val(data[0].user_name);
          $("#userpass").val(data[0].password);
          $("#selsequence").val(data[0].sequence);
          $("#selyg").val(data[0].detect_level);
          $("#selpc").val(data[0].stay_time);
          if(data[0].camcj == '5')
          {
            $("#dvadd").show();
            $(".dvadd").hide();
          }
          else{
            $("#dvadd").hide();
            $(".dvadd").show();
          }
          
          var unitType = data[0].category.split(",");
          for (var j = 0; j < unitType.length; j++) {
            var unitTypeCheckbox = $("input[id='feedback']");
            for (var i = 0; i < unitTypeCheckbox.length; i++) {
              if (unitTypeCheckbox[i].value == unitType[j]) {
                unitTypeCheckbox[i].checked = true;
              }
            }
          }

          form.render();
        });
      }
    }

    function closewindow() {
      var index = parent.layer.getFrameIndex(window.name);
      parent.layer.close(index);
    }

    function getrtsp(oip,oport,oname,opass,ocj,oml)
    {
      var vrtsp = '';
      if(ocj == '1')
      {
        if(oml == '1')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/cam/realmonitor?channel=1&subtype=0';
        }
        else if(oml == '2')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/cam/realmonitor?channel=1&subtype=1';
        }
        else
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/cam/realmonitor?channel=1&subtype=2';
        }
      }
      else if(ocj == '2')
      {
        if(oml == '1')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/Streaming/Channels/101?transportmode=unicast';
        }
        else if(oml == '2')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/Streaming/Channels/102?transportmode=unicast';
        }
        else
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/Streaming/Channels/103?transportmode=unicast';
        }
      }
      else if(ocj == '3')
      {
        if(oml == '1')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/video1';
        }
        else if(oml == '2')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/video2';
        }
        else
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/video3';
        }
      }
      else if(ocj == '4')
      {
        if(oml == '1')
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/id=0';
        }
        else
        {
          vrtsp = 'rtsp://' + oname + ':'+opass+'@'+oip+':'+oport+'/id=1';
        }
      }
      return vrtsp;
    }

    function chgLang() {
      $("#sp1").text(dictionaries_message41);
      $("#sp3").text(dictionaries_message182);
      $("#lab1").text(dictionaries_message268);
      $("#lab2").text(dictionaries_message62);
      $("#sp10").text(dictionaries_message230);
      $("#sp11").text(dictionaries_message43);
      $("#sp12").text(dictionaries_message3);
      $("#sp13").text(dictionaries_message4);
      $("#sp14").text(dictionaries_message231);
      $("#sp15").text(dictionaries_message240);
      $("#imsg1").text(dictionaries_message242);
      $("#imsg2").text(dictionaries_message243);
      $("#imsg3").text(dictionaries_message270);
      $("#laysavebutton").text(dictionaries_message63);
      $("#sp100").text(dictionaries_message269);
      

      $("#selml").empty();
      $('<option value="2">' + dictionaries_message237 + '</option>').appendTo($("#selml"));
			$('<option value="1">' + dictionaries_message236 + '</option>').appendTo($("#selml"));
      $('<option value="3">' + dictionaries_message238 + '</option>').appendTo($("#selml"));

      $("#selcj").empty();
			$('<option value="1">' + dictionaries_message232 + '</option>').appendTo($("#selcj"));
			$('<option value="2">' + dictionaries_message233 + '</option>').appendTo($("#selcj"));
      $('<option value="3">' + dictionaries_message234 + '</option>').appendTo($("#selcj"));
			$('<option value="4">' + dictionaries_message235 + '</option>').appendTo($("#selcj"));
      $('<option value="5">' + dictionaries_message239 + '</option>').appendTo($("#selcj"));

      $("#selsequence").empty();			
      $("#selyg").empty();
      $("#selpc").empty();
      for(selc=1;selc<11;selc++)
      {
        $('<option value="' + selc + '">' + selc + '</option>').appendTo($("#selsequence"));
        $('<option value="' + selc + '">' + selc + '</option>').appendTo($("#selyg"));
        $('<option value="' + selc + '">' + selc + '</option>').appendTo($("#selpc"));
        
      }

      $("#selyg").val('5');
      $("#selpc").val('2');
      $("#username").val('admin');

			form.render();
    }
  </script>
</body>
</html>